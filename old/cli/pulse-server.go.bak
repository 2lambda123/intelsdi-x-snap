package main

import (
	"github.com/intelsdi/pulse/agent"
	"github.com/go-martini/martini"
	"fmt"
    "encoding/json"
)

func main() {
	m := martini.Classic()

	m.Get("/metrics", func() string {
		metrics := agent.GetMetricValues(29)
		w := "<html><head><meta http-equiv=\"REFRESH\" content=\"1;URL=/metrics\"></head><body><table>"
		for _, m := range metrics{
			for k := range m.Values {
				w = w + "<tr>"
				w = w + "<td>" + m.Host + "</td>"
				w = w + "<td>" + m.GetNamespaceString() + "</td>"
				w = w + "<td>" + k + "</td>"
				w = w + "<td>" + fmt.Sprintf("%v",m.Values[k]) + "</td>"
				w = w + "</tr>"
			}
		}
		w = w + "</body></table></html>"
		return w
	})

	m.Get("/metrics/json", func() string {
		metrics := agent.GetMetricValues(29)
		w, _ := json.Marshal(metrics)
		return string(w)
	})

	m.Run()
}
